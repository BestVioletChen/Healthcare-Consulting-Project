---
title: "Consulting_2 Project"
output:
  pdf_document:
    fig_width: 6
    fig_height: 4
    fig_caption: true
indent: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
source("clean_data.R")
source("EDA2.R")
pacman::p_load(rstan,rstanarm, arm, ggpubr)
```
# Introduction

  Wanyu came to ask with questions about her study of the bruising detection and documentation with alternate light source. Her questions are about:  
1.Optimal solution in the factor: day (from the period)/wavelength/exposure/participants proportion.  
2.Persistence of variables:gender,age, BMI, muscle mass.  
3.Comparison of peer review performance.   

  Due to the participants' drop-out, there were 51 individuals(data points) in the study. Additional sheet joins these individual performances with physical measurements(Gender,BMI,Muscle Mass,Fat percentage, Days bruise remains visible). Below is the visualization,statistical analysis and modeling of the experiment.   


# Visualizations
## Overall
```{r}
text_size <- 10
line_proportion <- prop %>% ggplot(aes(x=time_text,y=m_val,group=light,color=light))+
  geom_point(size = 1.5)+
  geom_line(linetype = "dashed",size=1)+
  xlab("Time Interval")+ ylab("Proportion of Visible Bruises")+
  labs(title = "Proportion of visible bruises") +
  scale_color_manual("light",values = c("#3e236e", "#673AB7", "#9370d2",
                                        "#0044a9", "#1B76FF", "#76adff",
                                        "#28602b", "#43A047", "#87cd8a",
                                        "#464646", "#757575", "#acacac"))+
  theme(legend.position = "right")+
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(size = text_size),
          axis.text.y = element_text(size = text_size),
          axis.title.x = element_text(size = text_size),
          axis.title.y = element_text(size = text_size))+
    theme( strip.text.x = element_text(size = text_size), 
           strip.text.y = element_text(size = text_size),
           legend.title = element_text(size=text_size),
           legend.text = element_text(size=text_size),
           plot.title = element_text(size = text_size),
           legend.key.size = unit(.5, 'cm'))

ggsave("line_time.png", line_proportion, width = 16, height = 9, units = "cm")
```

```{r}
line_proportion

```
This figure illustrates proportion of visible bruise under different wave length and exposure. The y-axis is the proportion value of visible bruises, and the x-axis is the time interval, which corresponds to time change. Each line represents to different wavelengths under three exposure. And the color of each line corresponds to the color of these light under different exposures in real life. It is clear that with a light wavelength of 415nm or 460nm under exposure of -1, bruising visible proportion is relatively high. In addition, except 550nm light, which are always in low proportion of visible bruises, other light are all have high proportion in 0h after the experiment. However, after three hours of experimentation, these proportions declined rapidly.
Base on the general figure above, we added some additional factors and tried to find whether these factors would make influence on our result.

## Gender
```{r}
options(dplyr.summarise.inform = FALSE)

cols <- c("time_text", "Gender")
prop2 <- part1_clean %>% 
  group_by(across(all_of(cols))) %>% 
  summarize(m_val = mean(value),
            n = n()) %>% 
  mutate(prop_conf_int = 1.96*sqrt((m_val*(1-m_val))/n))


gender_bar <- prop2 %>%
  ggplot(aes(x = time_text, y = m_val, fill=Gender))+
  geom_bar(stat = "Identity", position = position_dodge(), color = "black")+
  geom_errorbar(mapping = aes(x = time_text, ymin = m_val - prop_conf_int,
                                             ymax = m_val + prop_conf_int,
                                 width = 0), position=position_dodge(.9), size = 0.7 )+
  geom_text(aes(y=0.02,label = n, vjust = 0),size =2, position = position_dodge(width= 0.9))+
  labs(title = "Proportion of visible bruises by gender") +
  theme(legend.position = "bottom")+
  ylab("Proportion of visible bruises") + xlab("Time")

ggsave("gender_bar.png", gender_bar, width = 16, height = 9, units = "cm")

```

```{r}
gender_bar
```

From this bar plot, we can see the proportion of visible bruises change shows a similar trend between males and females. But it is clear that females have a much higher proportion of visible bruises than males, regardless of the time interval changes after the experiment. Besides, we cannot gain any direct conclusion like 'the proportion of visible bruises are higher in females than males'. Because the number of people is changing throughout the experiment, and we've removed some of the data that turned out to be invisible or unclear.


## Skin Tone
  We would expect skin tone to have an impact on bruising visualization. The below plot shows the proportion of visible bruises by skin tone. Each bar represents the proportion of bruises visualized. The number at the bottom of the bar is the number of images that are included in that group, and the vertical black lines show the 95% confidence interval of the proportion. 
  We were surprised to see that skin tone 4 had the highest rate of bruise identification, but we believe this result could be due to the small sample size of the skin tone 4 group. Two subjects in this study had skin tone in category 4. Groups 1, 2, and 3, all have similar rates of bruising visualization within 3 percentage points of each other. This again makes the results for skin tone 4 surprising and justifies increased scrutiny of this result.
```{r, fig.width=7, fig.height=7/1.6}
skin_bar
```



## BMI 
In the following plot, we have visualized the proportion of bruises grouped by BMI category. We obtained the groupings from the [National Institute of Health's National Heart, Lung, and Blood Institute.](https://www.nhlbi.nih.gov/health/educational/lose_wt/BMI/bmi_dis.html)   As with skin tone, each bar has the 95% confidence interval of the proportion and the sample size. It seems that underweight individuals have the highest rate of bruise visualization, although they also have the smallest sample size, so there are large error bounds. 


```{r}
bmi_bar
```
Next, we look at the proportion of bruises visualized grouped by gender and BMI category. No males are in the underweight category, so there is only a single bar. The female underweight category also has the smallest sample size. Females seem to have higher rates of bruising visualization than males across BMI categories. 
```{r}
bmi_bar2
```

## Fat Content and Muscle Mass

When examining the fat content of an individual and their proportion of visualized bruises, we used a scatter plot with linear regression lines separated by gender. We can see that there are different patterns for males and females, since there is a gender difference in fat content. 

```{r, results='hide',fig.keep='all'}
ggarrange(fat_plot, mm_plot, common.legend = TRUE)
```


There is a more distinct gender divide for male and female muscle mass. In general, females have a higher rate of bruising visualization and a lower muscle mass. There could be other factors that are contributing to this trend that are not shown.


# Model
  We fit a logistic regression model to examine the effects of skin tone, light wavelength, photograph exposure, and time. Logistic regression is a type of regression that models a binary response. In this case, the binary response is bruising visualization. If a bruise is visible, the result is coded as 1, and if a bruise is not visible, the result is coded as 0. The mathematical formula is $log(\frac{\pi}{1-\pi}) = \beta_0 + \beta_1X_1 + ... \beta_kX_k$ where $log(\frac{\pi}{1-\pi})$ is the log odds of success (identification of bruises) and the expression on the right side of the equal sign is akin to regular least squares linear regression. Here is an example of what a logistic regression curve could look like. In this example, as X increases, the probability of Y being a success, or equal to one, decreases. 
```{r, fig.width=4, fig.height = 4/1.6}
ggplot(mtcars, aes(x=hp, y=vs)) + 
  geom_point(alpha=.5) +
  stat_smooth(method="glm",formula =  'y ~ x',  se=FALSE, method.args = list(family=binomial))+
  xlab("X") + ylab("y") + scale_y_continuous(breaks = c(0,1)) + theme_classic()
```
  For the bruising logistic regression model, we included skin tone, time since bruising, wavelength of light, and photograph exposure. We also included a "random effect" for each subject. We know that each image is not independent of the others, since subjects were photographed multiple times. This random intercept helps account for the correlation within the data. 
  In random effect modeling, we assume an overall distribution where each subject produces data that are within this overall distribution. Each subject's data compose the overall distribution.  

**Logistic Regression and Random Effect Resources:**   
https://online.stat.psu.edu/stat462/node/207/  
https://www.statology.org/logistic-regression/  
https://bookdown.org/steve_midway/DAR/random-effects.html    

```{r}
# Fit model

#mdl_re_int <- stan_glmer(formula = value ~  skin_tone +Gender +mm_scale + fat_scale + time_n + wave_length + exp_n1 + exp_p1 + fat*Gender+ (1|Subject), family=binomial(link="logit"), data=part1_clean) 
#saveRDS(mdl_re_int, "mdl_re_int.rds")

#load model - since it's slow to fit, we saved the results to lead each time we run the code
mdl <- readRDS("mdl_re_int.rds")
params <- names(mdl$coefficients)
```

  In the table and figure below, we show several of the estimated coefficients for the logistic regression model. The mean is the point estimate of the coefficient. The next columns, sd, 2.5% and 97.5% show the variation in these point estimates. The sd column is the standard deviation. The 2.5% and 97.5% columns show the confidence interval of the coefficient. If this estimate crosses zero, we say it is not statistically significant, but this does not mean that the parameter is without practical meaning. The last two rows of the table show a sampling of the intercepts that have been fit for each subject. Please refer to the appendix for the complete model output. For categorical variables, we set a baseline category. This is the category to which the others are compared. Skin tone and time were numeric values. Skin tone was measured as an integer 1 to 4 and time is coded in days, so 0.125 the value for 3 hours. In the model 0 exposure is the baseline. Variable "exp_n1" corresponds to a negative one exposure, and "exp_p1" corresponds to a positive one exposure. 

```{r}
knitr::kable(summary(mdl, probs = c(0.025, 0.975))[1:14,c(1,3:5)], digits =1)
```

```{r, message=FALSE, warning=FALSE, fig.width=6, fig.height=6/1.618, fig.cap = "Estimates of model coefficients. If the red bar crosses 0, the coeficcient is statistically insignificant at the 95% confidence level. Please note that these coefficients represent comparisons. For example, using wavelength 460nm does not have no effect in visualizing bruises, since the coefficient is nearly zero, rather 460nm is not statistically different from the 415nm baseline."}
stan_plot(mdl, pars = params[1:20], ci_level = 0.95, outer_level = 0.95, point_est = "mean")
```

The model indicates that the following parameters lead to a higher probability of bruise identification.  

1. **Time**: Time 0h had the highest rate of bruise identification. We believe that this result could be due to general skin redness and not a true bruise, since at 3h, fewer bruises were identified. Other than 0h, 3 days after bruising yields the next highest proportion of visualized bruises, as shown in the line plot and in the model coefficient for 3d. 

2. **Wavelength**: Our model considers 415 nm to be the baseline wavelength and the coefficients in the model compare bruising rates of a given wavelength to bruising rates using 415 nm light. The model shows that 415 and 460 nm had no distinguishable difference in visualizing bruising when compared to each other. When compared to 415 nm and 460 nm, 550 nm and white light did comparatively worse at visualizing bruises.  

3. **Exposure**: The differences in exposure's relationships with visualizing bruises is less extreme than that of light wavelength, but still detectable. Exposure level -1 is the baseline in the model, and 0 and +1 exposures were compared against this. The model shows that exposure -1 images correspond with a higher rate of bruise identification, although 0 exposure is slightly less effective at visualizing bruises, and +1 exposure is the least effective.    

4. **Skin tone**: In this model, level 1 skin tone is the baseline. All skin tones correspond with a similar rate of bruise identification. Skin tone 1 has a higher rate of bruising identification than levels 2 and 3. It is surprising to see that skin tone 4 has the highest rate of bruise visualization, but we believe that this result is due to a small sample size for this skin tone. Approximately 4% of the images are for individuals with a level 4 skin tone. This result should be taken with caution due to the small sample size of skin tone 4. 


# Conclusions

  As a result of all visualization and analysis, we have a clear overview for the experiment. Among all the factors in the data, time,wavelength, exposure and skin tone are decisive factors of bruise identification. For 21-day period, 3 days shows highest porprotion of visualized bruise. As for the wavelength, while there is no significant difference between 415 and 460 nm, 550 nm whte light showed worse performance as visualization. For exposure, level "-1" shows highest rate of bruise identification. For skin tone, even though skin tone shows the highest rate, we may still concern the result with limited sample size. 


# Appendix 

## Complete model output
```{r}
knitr::kable(summary(mdl, probs = c(0.025, 0.975)), digits =1)
```

## Residual plots
```{r}
binnedplot(mdl$fitted.values, mdl$residuals)
```
The residual plot shows the difference between the model predicted value and the measured value. If a model is a good fit, we expect to see a "cloud" of points without a pattern. If the model is a perfect fit, we would see all of the points along the zero line, since there is no difference between the model prediction and the actual value. Since we have a binary outcome, we use a binned residual plot. This groups the observations and finds the average residual. This way we can better visualize any patterns. The gray lines represent ± two standard errors. Ideally, most of the data should fall within these gray lines. In the below plot, we can observe a pattern closer to x = 0, where there is a probability of bruising that is less than 10%. The point that is around x = 0.3, is also of note. 




```{r}
pp_check(mdl)
```

```{r}
stan_plot(mdl, pars = names(mdl$coefficients)[1:12], ci_level = 0.95) + labs(title = "Fixed effect coefficient estimates")
```

```{r, fig.width =6.5, fig.height=7}
stan_plot(mdl, pars = names(mdl$coefficients)[13:65], ci_level = 0.95)+ #make the plot
  theme(axis.text.y = element_text(face = "plain", size = 9)) + #clean up y axis tick labels
  #scale_y_continuous(name = "Subject ID", breaks =seq(1,52,1), labels= str_extract(names(mdl$coefficients)[13:65], "\\d{1,2}")) +
  labs(title = "Random Intercepts")+ #add labels to axes
  ylab("Subject ID")+ xlab("Intercept Coefficient Estimate") + 
  theme(axis.title = element_text()) #show labels
```
